{"version":3,"file":"Main.js","sourceRoot":"","sources":["../src/Main.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n* Copyright (c) Bentley Systems, Incorporated. All rights reserved.\n* See LICENSE.md in the project root for license terms and full copyright notice.\n*--------------------------------------------------------------------------------------------*/\n\nimport { BentleyError } from \"@bentley/bentleyjs-core\";\nimport { ElectronAuthorizationBackend } from \"@bentley/electron-manager/lib/ElectronBackend\";\nimport {\n  BriefcaseDb, BriefcaseManager, CheckpointManager, IModelHost, IModelJsFs, NativeHost, ProgressFunction, RequestNewBriefcaseArg,\n} from \"@bentley/imodeljs-backend\";\nimport { IModelVersion, LocalBriefcaseProps, NativeAppAuthorizationConfiguration } from \"@bentley/imodeljs-common\";\nimport { AccessToken, AuthorizedClientRequestContext } from \"@bentley/itwin-client\";\n\nimport { DataExporter } from \"./DataExporter\";\n\nimport readline = require(\"readline\");\n\nasync function signIn(): Promise<AccessToken> {\n  const config: NativeAppAuthorizationConfiguration = {\n    clientId: \"imodeljs-electron-samples\",\n    redirectUri: \"http://localhost:3000/signin-callback\",\n    scope: \"openid email profile organization imodelhub context-registry-service:read-only product-settings-service urlps-third-party offline_access\",\n  };\n\n  const client = new ElectronAuthorizationBackend();\n  await client.initialize(config);\n\n  return new Promise<AccessToken>((resolve, reject) => {\n    NativeHost.onUserStateChanged.addListener((token) => {\n      if (token !== undefined) {\n        resolve(token);\n      } else {\n        reject(new Error(\"Failed to sign in\"));\n      }\n    });\n    client.signIn().catch((err) => reject(err));\n  });\n}\n\nasync function getBriefcase(requestContext: AuthorizedClientRequestContext, request: RequestNewBriefcaseArg): Promise<LocalBriefcaseProps> {\n  const briefcaseId = 0;\n  const fileName = request.fileName ?? BriefcaseManager.getFileName({ briefcaseId, iModelId: request.iModelId });\n\n  const asOf = request.asOf ?? IModelVersion.latest().toJSON();\n  const changeset = await BriefcaseManager.changesetFromVersion(requestContext, IModelVersion.fromJSON(asOf), request.iModelId);\n\n  const args = {\n    localFile: fileName,\n    checkpoint: {\n      requestContext,\n      contextId: request.contextId,\n      iModelId: request.iModelId,\n      changeSetId: changeset.id,\n      changesetIndex: changeset.index,\n    },\n    onProgress: request.onProgress,\n  };\n\n  await CheckpointManager.downloadCheckpoint(args);\n  const fileSize = IModelJsFs.lstatSync(fileName)?.size ?? 0;\n  const response: LocalBriefcaseProps = {\n    fileName,\n    briefcaseId,\n    iModelId: request.iModelId,\n    contextId: request.contextId,\n    changeSetId: args.checkpoint.changeSetId,\n    changesetIndex: args.checkpoint.changesetIndex,\n    fileSize,\n  };\n\n  return response;\n}\n\nexport async function main(process: NodeJS.Process): Promise<void> {\n  try {\n    await IModelHost.startup();\n\n    const accessToken: AccessToken = await signIn();\n\n    let userdata;\n    const json = process.argv[2];\n    if (json === undefined) {\n      userdata = require(\"../queries/example.json\");\n    } else {\n      userdata = require(json);\n    }\n\n    const url = new URL(userdata.url.toLowerCase());\n    const projectId: string = url.searchParams.get(\"projectid\") ?? \"\";\n    const iModelId: string = url.searchParams.get(\"imodelid\") ?? \"\";\n    const changeSetId: string = url.searchParams.get(\"changesetid\") ?? \"\";\n\n    const version = changeSetId === \"\" ? IModelVersion.latest() : IModelVersion.asOfChangeSet(changeSetId);\n\n    const guidRegex = new RegExp(\"[A-Fa-f0-9]{8}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{12}\");\n    if (!guidRegex.test(projectId) || !guidRegex.test(iModelId)) {\n      console.error(\"Error in parsing url from query\");\n      return;\n    }\n\n    // If this function returns non-zero, the download is aborted.\n    const progressTracking: ProgressFunction = (loaded: number, total: number): number => {\n      const percent = loaded / total * 100;\n      readline.cursorTo(process.stdout, 0);\n      process.stdout.write(`Downloaded: ${percent.toFixed(2)} %`);\n\n      return 0;\n    };\n\n    console.log(`Started opening iModel (projectId=${projectId}, iModelId=${iModelId}, changeSetId=${changeSetId})`);\n    const requestContext: AuthorizedClientRequestContext = new AuthorizedClientRequestContext(accessToken);\n    const requestNewBriefcaseArg: RequestNewBriefcaseArg = { contextId: projectId, iModelId, asOf: version.toJSON(), briefcaseId: 0, onProgress: progressTracking };\n    const briefcaseProps = await getBriefcase(requestContext, requestNewBriefcaseArg);\n    requestContext.enter();\n\n    const iModelDb = await BriefcaseDb.open(requestContext, briefcaseProps);\n    requestContext.enter();\n    console.log(\"\\nFinished opening iModel\");\n\n    const exporter = new DataExporter(iModelDb);\n    exporter.setFolder(userdata.folder);\n\n    for (const querykey of Object.keys(userdata.queries)) {\n      console.log(`Executing query for ${querykey}`);\n      const aQuery = userdata.queries[querykey];\n      const fileName = `${aQuery.store !== undefined ? aQuery.store : querykey}.csv`;\n      await exporter.writeQueryResultsToCsv(aQuery.query, fileName, aQuery.options);\n    }\n\n    iModelDb.close();\n  } catch (error) {\n    console.error(`${error.message}\\n${error.stack}`);\n  } finally {\n    await IModelHost.shutdown();\n  }\n}\n\nif (require.main === module) {\n  (async () => {\n    await main(process);\n  })().catch((err) => {\n    if (err instanceof BentleyError)\n      process.stderr.write(`Error: ${err.name}: ${err.message}`);\n    else\n      process.stderr.write(`Unknown error: ${err.message}`);\n    process.exit(err.errorNumber ?? -1);\n  });\n}\n"]}